<!DOCTYPE html>
<html>
<head>
    <title>Clip Fomatter Creater</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="file:///android_asset/css/jquery-ui.css">
    <style>

        * {
            font-size: 20px;
            color: #525252;
        }

        .container {
            height: 100%;
            overflow-x: hidden;
            position: relative;
            padding-bottom: 50px;
        }

        .overlay {
            content: "";
            display: block;
            width: 0;
            position: fixed;
            height: 0;
            /*		background-color: rgba(0, 0, 0, 0.5);*/
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 2;
            opacity: 0;
            transition: opacity .5s;
        }

        .overlay.open {
            width: 100%;
            height: 100%;
            opacity: 1;
        }

        .menu-trigger {
            display: block;
            cursor: pointer;
            transform: translateX(0);
            transition: transform .5s;
        }

        nav {
            width: 150px;
            height: 100%;
            padding-top: 100px;
            background-color: rgb(245, 245, 245, 0.8);
            position: fixed;
            top: 0;
            right: 0;
            z-index: 10;
            transform: translate(150px);
            transition: all .5s;
        }
        nav.open {
            transform: translateZ(0);
        }

        nav ul {
            list-style: none;
            padding-left: 0;
        }

        .bottom-btn-box {
            display: flex;
            position: fixed;
            width: 95%;
            bottom: 0;
            z-index: 10;
            background-color: white;
        }

        .btn-success {
            display: block;
            width: 80%;
            margin: 10px;
            padding: 10px;
            background-color: #cef0f5;
            border: none;
            user-select: none;
        }

        .sortable {
            display: block;
            width: 95%;
            margin: 0 auto;
            padding: 10px;
        }
        .sortable .list-box {
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 12px;
            cursor: move;
        }
        .sortable .list-box:hover {
            box-shadow: 2px 2px 2px rgba(189, 189, 189, .7);
        }

        .cb-dialog-item {
            display: block;
            padding: 10px;
            background-color: #cef0f5;
            margin: 2px auto;
            width: 90%;
        }

        .edit-cb-input {
            display: block;
            width: 80%;
            margin:2px auto;
        }

        .btn-primary {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 10px;
            background-color: #cef0f5;
            border: none;
            user-select: none;
        }

        .editLabel {
            display: block;
            width: 95%;
        }

        select {
            user-select: none;
        }

        .edit-field {
            user-select: none;
        }

        label {
            user-select: none;
            margin-left: 10px;
        }

        .sotable-btn-valname-box {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 90%;
        }

        .sotable-input {
            display: block;
            margin: 5px auto;
            width: 90%;
        }

        .new-line {
            background-color: #ededed;
        }

        .plain-text {
            background-color: #C3FEA3;
        }

        .label-text {
            background-color: #b3fcc7;
        }

        .cb-item {
            background-color: #cffafc;
        }

        .url-launch-or-copy {
            background-color: #FBF8BD;
        }

        .disabled {
            pointer-events: none;
            color: #C5C5C5;
        }

    </style>
</head>
<body>

<div class="container">

    <div class="sortable" id="sortable-fields">
    </div>

    <br>
    <div class="bottom-btn-box">
        <button class="btn btn-success menu-trigger" id="addItems">add</button>
        <button class="btn btn-success" id="createFannel">create</button>
    </div>

    <nav>
        <ul>
            <li>
                <button class="btn btn-primary url-launch-or-copy" id="addUpUrlOrClipField">urlOrCp</button>
            </li>
            <li>
                <button class="btn btn-primary label-text" id="addTextWithLabelField">lTxt</button>
            </li>
            <li>
                <button class="btn btn-primary new-line" id="addNewlineField">wrap</button>
            </li>
            <li>
                <button class="btn btn-primary plain-text" id="addTextField">text</button>
            </li>
            <li>
                <button class="btn btn-primary cb-item" id="addField">select</button>
            </li>
        </ul>
    </nav>
    <div class="overlay"></div>

    <div class="dialog" style="display:none;">
        <div class="dialogForm">
        </div>
    </div>
    <script type="text/javascript" src="file:///android_asset/js/jquery-3.6.3.min.js"></script>
    <script type="text/javascript" src="file:///android_asset/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="file:///android_asset/js/Sortable.js"></script>
    <script type="text/javascript" src="file:///android_asset/js/long-press-event.min.js"></script>
    <script>

        const createClipPath = 'CLIP_MAKER_TARGET_JS_PATH';
        const createClipName = createClipPath.split("/").at(-1);
        const siteTitlePrefix = "Clip Fomatter Creater For"
        const targetFileName = createClipName.replace(/\.js$/, '');
        const createClipPathList = createClipPath.split("/");
        if(createClipPathList.length > 2){
            var parentDirPath = createClipPathList.slice(0, createClipPathList.length - 1).join("/");
        } else var parentDirPath = "";
        const targetAppDirPath = `${parentDirPath}/${targetFileName}Dir`
        const targetAppListDirPath = `${targetAppDirPath}/list`
        const siteTitle = [siteTitlePrefix, targetFileName].join(' ');
        const S="abcdefghijklmnopqrstuvwxyz";
        const N=5;
        const zenkakuSimbolRegex = /[^a-zA-Z0-9_]/;
        const prefixNumRegex = /^[0-9]/;
        const urlLaunchVariablePrefix = "upUrlOrCp";
        const setVariableTypeName = 'setVariableTypes';
        const newlineVariableName = "newline";
        const elcbMark = "TXT:ELSB"
        const elcbbMark = "TXT:ELSB:BTN"
        let INPUT_CLASS_TYPE = {
            cbFormFieldClass: 'cb-form-field',
            textFormFieldClass: 'text-form-field',
            textWithLabelFormFieldClass: 'text-with-label-form-field',
            urlFormFieldClass: 'url-form-field',
            newLineFieldclass: 'newLine-field'
        };
        let INPUT_BLOCK_CLASS = {
            cbItemBlock: 'cb-item',
            plainTextBlock : 'plain-text',
            labelTextBlock: 'label-text',
            newLineBlock: 'new-line',
            upUrlOrCopyBlock: 'url-launch-or-copy',
            listBoxBlock: 'list-box',
        };
        const newlineVariableValue = "cmdclickNewline";
        const newlineVariableValueEscape = "// " + newlineVariableValue
        const scriptFirst = `let args = jsArgs.get().split("\\t");
		|const firstArgs = args.at(0);
		|
		|let currentFilePathList = "\${0}".replace(/^file:\\/\\//, '').split('/');
		|const parentDirPath = currentFilePathList.slice(0, currentFilePathList.length - 1).join('/');
		|
		|const clipMode = "";
		|const urlLaunchMode = "url";\n\n`
            .split('\n')
            .map(function(line){
                return line.trim().replace(/^\|/, '');
            }).join("\n");
        const launchUrlFunction = `
		|function urlLaunchOrClip(LAUNCH_URL){
		|	if(
		|		LAUNCH_URL.startsWith("https://")
		|		|| LAUNCH_URL.startsWith("http://")
		|		|| LAUNCH_URL.startsWith("/")
		|		|| LAUNCH_URL.startsWith("file://")
		|	){
		|		jsUrl.loadUrl(LAUNCH_URL);
		|		return;
		|	};
		|	jsUtil.copyToClipboard(LAUNCH_URL, 10);
		|	jsToast.short("text to clipboard");
		|};\n\n`.split('\n')
            .map(function(line){
                return line.trim().replace(/^\|/, '');
            }).join("\n");


        let EDIT_FIELD_ID = {
            sortableFields: 'sortable-fields',
        }

        let SET_VAL_TYPE_JANRE = {
            name: 'name',
            value : 'value',
            supVal : 'supVal',
            valType : 'valType',
        };

        let READ_VAL_TYPE = {
            ELCB: 'TXT:ELSB',
            TXT: 'TXT',
            ELCBB: 'TXT:ELSB:BTN',
            LTXT: 'LTXT',
            NEWLINE: 'NEWLINE'
        };

        let TORIGER_BUTTON_ID = {
            addItems: 'addItems',
            createFannel: 'createFannel',
        };

        let TORIGER_BUTTON_CLASS = {
            menuTrigger: 'menu-trigger',
        };

        let OPEN_PARTS_NAME = {
            nav: 'nav',
            overlayClass: 'overlay',
        };

        let ADD_EDIT_COMPONENT_ID = {
            addField: 'addField',
            addTextField: 'addTextField',
            addTextWithLabelField: 'addTextWithLabelField',
            addNewlineField: 'addNewlineField',
            addUpUrlOrClipField: 'addUpUrlOrClipField',
        }

        let EDIT_COMPONENT_CHILD_CLASS = {
            editField: `edit-field`,
        }

        let elcbKeys = {
            listPath: "listPath",
            limitNum: "limitNum",
        };

        let ButtonKeys = {
            cmd: "cmd",
            label: "label",
        };

        $(document).ready(function() {
            document.title = siteTitle;
            readVariables();

            $(`.${TORIGER_BUTTON_CLASS.menuTrigger}`).on('click',function(){
                if($(this).hasClass('active')){
                    $(this).removeClass('active');
                    $(OPEN_PARTS_NAME.nav).removeClass('open');
                    $(`#${TORIGER_BUTTON_ID.addItems}`).text("add");
                    $(`#${TORIGER_BUTTON_ID.createFannel}`).removeClass('disabled');
                    $(`.${OPEN_PARTS_NAME.overlayClass}`).removeClass('open');
                } else {
                    $(this).addClass('active');
                    $(OPEN_PARTS_NAME.nav).addClass('open');
                    $(`#${TORIGER_BUTTON_ID.addItems}`).text("close");
                    $(`#${TORIGER_BUTTON_ID.createFannel}`).addClass('disabled');
                    $(`.${OPEN_PARTS_NAME.overlayClass}`).addClass('open');
                }
            });
            $(`.${OPEN_PARTS_NAME.overlayClass}`).on('click',function(){
                if($(this).hasClass('open')){
                    $(this).removeClass('open');
                    $(`#${TORIGER_BUTTON_ID.addItems}`).text("add");
                    $(`#${TORIGER_BUTTON_ID.createFannel}`).removeClass('disabled');
                    $(`.${TORIGER_BUTTON_CLASS.menuTrigger}`).removeClass('active');
                    $(OPEN_PARTS_NAME.nav).removeClass('open');
                }
            });


            // フィールドの追加
            $(`#${ADD_EDIT_COMPONENT_ID.addField}`).click(function() {
                const rundomStr = makeRandomValName()
                appendElcbBox(rundomStr);
            });

            $(`#${ADD_EDIT_COMPONENT_ID.addTextField}`).click(function() {
                const rundomStr = makeRandomValName()
                appendTextField(rundomStr, "");
            });

            $(`#${ADD_EDIT_COMPONENT_ID.addTextWithLabelField}`).click(function() {
                const rundomStr = makeRandomValName()
                appendTextWithLabelField(rundomStr, "");
            });

            $(`#${ADD_EDIT_COMPONENT_ID.addNewlineField}`).click(function() {
                appendNewLineField();
            });

            $(`#${ADD_EDIT_COMPONENT_ID.addUpUrlOrClipField}`).click(function() {
                const rundomStr = makeRandomValName()
                appendUrlLaunchButton(`${urlLaunchVariablePrefix}_${rundomStr}`, "");
            });

            // フィールドのedit
            $(`#${EDIT_FIELD_ID.sortableFields}`).on(
                'click',
                `.${EDIT_COMPONENT_CHILD_CLASS.editField}`,
                function() {
                    let sotableBtnValnameBox = $(this).parent();
                    let listBlock = sotableBtnValnameBox.parent();
                    editSelect(
                        listBlock,
                        sotableBtnValnameBox
                    );
                });

            // フィールドの並び替え
            $(function() {
                sortableJsWrapper(`${EDIT_FIELD_ID.sortableFields}`);
            });


            $(`#${TORIGER_BUTTON_ID.createFannel}`).click(function() {
                let cmdVariableList = [];
                let setVariableTypeList = [];
                let variableListForTextWithLabel = [];
                let clipVariablesList = [];
                let elcbVariablesList = [];
                let launchVariableList = [];

                let soutableFields = $(`#${EDIT_FIELD_ID.sortableFields}`)
                let inputParts = soutableFields.children()
                var newLineForDisplay = "";
                inputParts.each(function(index) {
                    let currentInputForm = $(this);
                    const className = currentInputForm.attr('class');
                    switch (true){
                        case className.includes(
                            INPUT_CLASS_TYPE.cbFormFieldClass
                        ):
                            getFromElcbForm(
                                currentInputForm,
                                cmdVariableList,
                                clipVariablesList,
                                setVariableTypeList,
                                elcbVariablesList
                            )
                            break;
                        case className.includes(
                            INPUT_CLASS_TYPE.textFormFieldClass
                        ):
                            getFromTextForm(
                                currentInputForm,
                                cmdVariableList,
                                clipVariablesList,
                                setVariableTypeList
                            )
                            break;
                        case className.includes(
                            INPUT_CLASS_TYPE.textWithLabelFormFieldClass
                        ):
                            getFromTextWithLabelForm(
                                currentInputForm,
                                cmdVariableList,
                                clipVariablesList,
                                setVariableTypeList,
                                variableListForTextWithLabel
                            )
                            break;
                        case className.includes(
                            INPUT_CLASS_TYPE.urlFormFieldClass
                        ):
                            getFromUrlLaunchForm(
                                currentInputForm,
                                cmdVariableList,
                                setVariableTypeList,
                                launchVariableList,
                            )
                            break;
                        case className.includes(
                            INPUT_CLASS_TYPE.newLineFieldclass
                        ):
                            getFromNewLineForm(
                                inputParts,
                                index,
                                clipVariablesList,
                                cmdVariableList,
                                setVariableTypeList,
                            )
                            break;
                    }
                });

                const descriptionSections = createDescriptionSection(
                    variableListForTextWithLabel,
                    launchVariableList,
                );

                const settingVariableSections = createSettingVariableSection(
                    setVariableTypeList
                );

                const commandVariableSections = createCommandVariableSection(
                    cmdVariableList,
                );

                const jsBodyScript = createJsBodyScript(
                    clipVariablesList,
                    elcbVariablesList,
                    launchVariableList,
                    variableListForTextWithLabel
                );

                const jsFileContents = [
                    descriptionSections,
                    "\n",
                    settingVariableSections,
                    "\n",
                    commandVariableSections,
                    "\n",
                    "/// Please write bellow with shell script",
                    "\n\n",
                    jsBodyScript,
                ].join("\n")

                jsFileSystem.writeLocalFile(
                    createClipPath,
                    jsFileContents
                );
                const jumpConfirm = confirm(
                    `create ok,  jump ${targetFileName}.js ?`
                );
                if(jumpConfirm){
                    jsIntent.launchShortcut(
                        parentDirPath,
                        `${targetFileName}.js`
                    );
                }
            });

            $(`#${TORIGER_BUTTON_ID.addItems}`).on('long-press',function(){
                jsToast.long("Add item");
            });
            $(`#${TORIGER_BUTTON_ID.createFannel}`).on('long-press',function(){
                jsToast.long("Create clip formater fannel");
            });
            $(`.${INPUT_BLOCK_CLASS.plainTextBlock}`).on('long-press',function(){
                jsToast.long("Add plain text field");
            });
            $(`.${INPUT_BLOCK_CLASS.labelTextBlock}`).on('long-press',function(){
                jsToast.long("Add plain text with label(variable name) field");
            });
            $(`.${INPUT_BLOCK_CLASS.upUrlOrCopyBlock}`).on('long-press',function(){
                jsToast.long("Add url launch or copy button");
            });
            $(`.${INPUT_BLOCK_CLASS.cbItemBlock}`).on('long-press',function(){
                jsToast.long("Add select box field");
            });
            $(`.${INPUT_BLOCK_CLASS.newLineBlock}`).on('long-press',function(){
                jsToast.long("Add new line");
            });
        });


        function readVariables(){
            jsFileSystem.createDir(
                targetAppListDirPath
            );
            const jsFannelContents = jsFileSystem.readLocalFile(createClipPath
            );
            if(!jsFannelContents) return
            const settingVals = jsScript.subSettingVars(
                jsFannelContents
            );
            let setVariableTypeList = jsScript.subValOnlyValue(
                setVariableTypeName,
                settingVals,
            ).replaceAll("\n", ",").split(",");
            let setValTypeMap = makeSetValTypeMap(
                setVariableTypeList
            )
            let cmdValMapList = makeCmdMapList(
                jsFannelContents,
                setValTypeMap
            )
            execAddClipParts(
                cmdValMapList,
            );
        }

        function makeSetValTypeMap(
            setVariableTypeList
        ){
            const setVariableTypeMapList = setVariableTypeList.map(
                function (line) {
                    let lineList = line.split('=')
                    const keySourceList = lineList.at(0).split(":");
                    const key = keySourceList.at(0);
                    if(keySourceList.length > 1){
                        var valType = keySourceList.slice(1).join(":");
                    } else {
                        var valType = "";
                    }
                    if(lineList.length > 1){
                        var supValue = lineList.slice(1).join('=');
                    } else {
                        var supValue = "";
                    }
                    var map = new Map(
                        [
                            [SET_VAL_TYPE_JANRE.valType, valType],
                            [SET_VAL_TYPE_JANRE.supVal, supValue]
                        ]
                    );
                    return [key, map]
                }
            )
            return new Map(
                setVariableTypeMapList
            )
        }


        function makeCmdMapList(
            jsFannelContents,
            setValTypeMap
        ){
            return jsScript.subCmdVars(
                jsFannelContents
            ).split("\n").map(
                function(line){
                    const nameValList = line.split("=");
                    const name = nameValList.at(0);
                    if(nameValList.length > 1){
                        const valueSource = nameValList.slice(1).join("=");
                        var value = jsScript.bothQuoteTrim(valueSource);
                    } else {
                        var value = "";
                    }
                    if(
                        value === undefined
                        || value == '\"\"'
                    ) value = "";
                    let currentValMap = setValTypeMap.get(name)
                    if(currentValMap === undefined){
                        const valType = decideValType(
                            name,
                            currentValMap,
                            jsFannelContents,
                        )
                        return new Map(
                            [
                                [SET_VAL_TYPE_JANRE.name, name],
                                [SET_VAL_TYPE_JANRE.value, value],
                                [SET_VAL_TYPE_JANRE.valType, valType],
                                [SET_VAL_TYPE_JANRE.supVal, ""]
                            ]
                        );
                    }
                    var supVal = "";
                    if(
                        currentValMap.has(SET_VAL_TYPE_JANRE.supVal)
                    ) supVal = currentValMap.get(SET_VAL_TYPE_JANRE.supVal);
                    else supVal = "";
                    const valType = decideValType(
                        name,
                        currentValMap,
                        jsFannelContents,
                    )
                    return new Map(
                        [
                            [SET_VAL_TYPE_JANRE.name, name],
                            [SET_VAL_TYPE_JANRE.value, value],
                            [SET_VAL_TYPE_JANRE.valType, valType],
                            [SET_VAL_TYPE_JANRE.supVal, supVal]
                        ]
                    );
                })
        }

        function execAddClipParts(
            cmdValMapList
        ){
            cmdValMapList.forEach((mapObj, index) => { // ★
                const name = mapObj.get(SET_VAL_TYPE_JANRE.name)
                const value = mapObj.get(SET_VAL_TYPE_JANRE.value)
                const supVal = mapObj.get(SET_VAL_TYPE_JANRE.supVal)
                const valType = mapObj.get(SET_VAL_TYPE_JANRE.valType)
                switch (valType){
                    case READ_VAL_TYPE.ELCB:
                        appendElcbBox(name)
                        break;
                    case READ_VAL_TYPE.TXT:
                        appendTextField(name, value);
                        break;
                    case READ_VAL_TYPE.LTXT:
                        appendTextWithLabelField(name, value)
                        break;
                    case READ_VAL_TYPE.ELCBB:
                        appendUrlLaunchButton(name, value)
                        break;
                    case READ_VAL_TYPE.NEWLINE:
                        appendNewLineField()
                        break;
                }
            });
        }

        function decideValType(
            name,
            currentValMap,
            jsFannelContents,
        ){
            var valType = "";
            if(
                currentValMap != undefined
                && currentValMap.has(SET_VAL_TYPE_JANRE.valType)
            ) valType = currentValMap.get(SET_VAL_TYPE_JANRE.valType);
            if(valType) return valType;
            if(
                name == newlineVariableValueEscape
            ) return READ_VAL_TYPE.NEWLINE;
            if(
                jsFannelContents.includes(`${name}: `)
            ) return READ_VAL_TYPE.LTXT;
            return READ_VAL_TYPE.TXT;
        }

        function appendElcbBox(label){
            const listFilePath = `${targetAppListDirPath}/${label}List`;
            let optionList = jsFileSystem.readLocalFile(
                listFilePath
            ).split("\n");
            const optionTags = optionList.map(
                function(option, index){
                    const value = index + 1
                    return `<option value="${value}">${option}</option>`
                }
            ).join('');
            $(`#${EDIT_FIELD_ID.sortableFields}`).append(`<div class="${INPUT_CLASS_TYPE.cbFormFieldClass} ${INPUT_BLOCK_CLASS.cbItemBlock} ${INPUT_BLOCK_CLASS.listBoxBlock}"><div class="sotable-btn-valname-box"><button class="btn btn-danger -field ${EDIT_COMPONENT_CHILD_CLASS.editField}">edit</button><label for="select">${label}</label></div><select id="select" class="sotable-input">${optionTags}</select></div>`);
        }

        function appendTextField(label, text){
            $(`#${EDIT_FIELD_ID.sortableFields}`).append(`<div class="${INPUT_CLASS_TYPE.textFormFieldClass} ${INPUT_BLOCK_CLASS.plainTextBlock} ${INPUT_BLOCK_CLASS.listBoxBlock}"><div class="sotable-btn-valname-box"><button class="btn btn-danger ${EDIT_COMPONENT_CHILD_CLASS.editField}">edit</button><label for="text">${label}</label></div><input id="text" class="sotable-input" type="text" value="${text}" /></div>`);
        }

        function appendTextWithLabelField(label, text){
            $(`#${EDIT_FIELD_ID.sortableFields}`).append(`<div class="${INPUT_CLASS_TYPE.textWithLabelFormFieldClass} ${INPUT_BLOCK_CLASS.labelTextBlock} ${INPUT_BLOCK_CLASS.listBoxBlock}"><div class="sotable-btn-valname-box"><button class="btn btn-danger ${EDIT_COMPONENT_CHILD_CLASS.editField}">edit</button><label for="text">${label}</label></div><input id="text"  class="sotable-input" type="text" value="${text}" /></div>`);
        }

        function appendNewLineField(){
            $(`#${EDIT_FIELD_ID.sortableFields}`).append(`<div class="${INPUT_CLASS_TYPE.newLineFieldclass} ${INPUT_BLOCK_CLASS.newLineBlock} ${INPUT_BLOCK_CLASS.listBoxBlock}"><div class="sotable-btn-valname-box"><label for="text">wrap</label></div></div>`);
        };

        function appendUrlLaunchButton(valName, urlStr){
            const listFilePath = `${targetAppListDirPath}/${valName}List`;
            let optionList = jsFileSystem.readLocalFile(
                listFilePath
            ).split("\n");
            const optionTags = optionList.map(
                function(option, index){
                    const value = index + 1
                    return `<option value="${value}">${option}</option>`
                }
            ).join('');
            $(`#${EDIT_FIELD_ID.sortableFields}`).append(`<div class="${INPUT_CLASS_TYPE.urlFormFieldClass} ${INPUT_BLOCK_CLASS.upUrlOrCopyBlock} ${INPUT_BLOCK_CLASS.listBoxBlock}"><div class="sotable-btn-valname-box"><button class="btn btn-danger -field ${EDIT_COMPONENT_CHILD_CLASS.editField}">edit</button><label for="select">${valName}</label></div><select id="select" class="sotable-input">${optionTags}</select></div>`);
        }

        function createDescriptionSection(
            variableListForTextWithLabel,
            launchVariableList,
        ) {
            const firstDescriptinHolder = "/// LABELING_SECTION_START";
            const endDescriptionHolder = "/// LABELING_SECTION_END";
            const firstSection = `\n\n${firstDescriptinHolder}
			|// clipboad formatter @maker
			|// ## Toolbar buttons
			|// --------
			|// ### Play Button
			|// Copy input contents
			|// ## Cmd Variables
			|// --------`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");
            const descForTextWithLable = variableListForTextWithLabel.map(
                function(variable){
                    return `// ${variable}: text input with label`
                }).join("\n");
            const descForLaunch = launchVariableList.map(
                function(variable){
                    return `// ### ${variable}
			|// Launch url`
                }).join("\n").split("\n").map(function(line){
                return line.trim().replace(/^\|/, '');
            }).join("\n");
            const endDescContents = `|//
			|// ## Setting Variables
			|// --------
			|// ### onUrlHistoryRegister
            |// Url history update signal
            |//
            |// | switch type | description |
            |// | ------- | ------- |
            |// | \`ON\` | update |
        	|// | \`OFF\` | no update |
        	|//
			|${endDescriptionHolder}`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");
            return [
                firstSection,
                descForTextWithLable,
                descForLaunch,
                endDescContents
            ].join("\n");
        };

        function createSettingVariableSection(
            setVariableTypeList
        ){
            const firstSettings = `/// SETTING_SECTION_START
		|editExecute="ALWAYS"
		|terminalOutputMode="NORMAL"
		|terminalSizeType="LONG"
		|onUrlHistoryRegister="OFF"
		|onAdBlock="OFF"
		|hideSettingVariables="editExecute"
		|hideSettingVariables="terminalOutputMode"
		|hideSettingVariables="terminalSizeType"
		|hideSettingVariables="onAdBlock"
		|hideSettingVariables="setVariableTypes"`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");

            const setVariableSettings = setVariableTypeList.join("\n")
            const endSettings = `scriptFileName="clipFormatter.js"
		|/// SETTING_SECTION_END`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");
            return [
                firstSettings,
                setVariableSettings,
                endSettings
            ].join("\n")
        };

        function createCommandVariableSection(
            cmdVariableList,
        ){
            const firstSettings = '/// CMD_VARIABLE_SECTION_START';
            const setVariableSettings = cmdVariableList.join("\n");
            const endSettings = '/// CMD_VARIABLE_SECTION_END';
            return [
                firstSettings,
                setVariableSettings,
                endSettings
            ].join("\n")
        }


        function createJsBodyScript(
            clipVariablesList,
            elcbVariablesList,
            launchVariableList,
            variableListForTextWithLabel
        ){
            const concatClipFunction = clipFunctionConcatter(
                clipVariablesList,
                elcbVariablesList,
                variableListForTextWithLabel
            )

            const switchFunction = switchFunctionConcatter(
                launchVariableList
            )

            return scriptFirst +
                "\n" + concatClipFunction +
                "\n" + launchUrlFunction +
                "\n" + switchFunction +
                "\n";
        }

        function switchFunctionConcatter(
            launchVariableList
        ){
            var switchFunction = `switch(firstArgs){
		|	case clipMode:
		|		execClipMode();
		|		break;\n`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");

            launchVariableList.forEach(function(variable){
                switchFunction += `|	case "${variable}":
			|		jsListSelect.updateListFileCon(
			|		\`${targetAppListDirPath}/${variable}List\`,
			|			${variable}
			|		);
			|		urlLaunchOrClip(${variable});
			|		break;\n`.split('\n')
                    .map(function(line){
                        return line.trim().replace(/^\|/, '');
                    }).join("\n");
            });
            switchFunction += "};"
            return switchFunction
        };

        function clipFunctionConcatter(
            clipVariablesList,
            elcbVariablesList,
            variableListForTextWithLabel
        ){
            var concatClipFunction = `function execClipMode(){
		|	var clipBody = "";
		|	var newlines = "";\n`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");
            clipVariablesList.forEach(function(variable){
                if(
                    variable == newlineVariableValueEscape
                ) {
                    concatClipFunction += `\n\tnewlines += "\\n";`;
                    return
                }
                var insertVarable = insertVariableForClip(
                    variableListForTextWithLabel,
                    variable,
                )
                concatClipFunction += `
			|	if(${variable}){
			|		clipBody += newlines + ${insertVarable} + "\\n";
			|	} else {
			|		newlines = "";
			|	};\n`.split('\n')
                    .map(function(line){
                        return line.trim().replace(/^\|/, '');
                    }).join("\n");
            });
            concatClipFunction += elcbVariablesList.map(
                function(variableName){
                    return `
				|	jsListSelect.updateListFileCon(
				|		\`${targetAppListDirPath}/${variableName}List\`,
				|		${variableName}
				|	);`.split('\n')
                        .map(function(line){
                            return line.trim().replace(/^\|/, '');
                        }).join("\n");
                }).join("\n");
            concatClipFunction += `
		|	jsUtil.copyToClipboard(clipBody, 10);
		|	jsToast.short(clipBody);
		|};`.split('\n')
                .map(function(line){
                    return line.trim().replace(/^\|/, '');
                }).join("\n");
            return concatClipFunction
        }

        function insertVariableForClip(
            variableListForTextWithLabel,
            variable,
        ){
            if(
                variableListForTextWithLabel.includes(variable)
            ){
                return [
                    `"${variable}: "`,
                    variable
                ].join(" + ");
            }
            return variable;
        }


        function getFromElcbForm(
            elcbFormFields,
            cmdVariableList,
            clipVariablesList,
            setVariableTypeList,
            elcbVariablesList
        ){
            elcbFormFields.each(function() {
                let listBlock = $(this);
                let sotableBtnValnameBox = listBlock.children('.sotable-btn-valname-box')
                const elcbVariableName = sotableBtnValnameBox.children('label').text();
                elcbVariablesList.push(elcbVariableName);
                cmdVariableList.push(`${elcbVariableName}=""`)
                clipVariablesList.push(elcbVariableName);
                let selectTag = listBlock.children('select');
                let options = selectTag.children();
                const listContents = options.map(function() {
                    return $(this).text()
                }).get().join('\n');
                const listFilePath = `${targetAppListDirPath}/${elcbVariableName}List`;
                setVariableTypeList.push(
                    `${setVariableTypeName}="${elcbVariableName}:${elcbMark}=${elcbKeys.listPath}=${listFilePath}?${elcbKeys.limitNum}=20"`
                );
                jsFileSystem.writeLocalFile(
                    listFilePath,
                    listContents
                );
            });
        }


        function getFromTextWithLabelForm(
            textFormFields,
            cmdVariableList,
            clipVariablesList,
            setVariableTypeList,
            variableListForTextWithLabel
        ){
            textFormFields.each(function() {
                let listBlock = $(this);
                let sotableBtnValnameBox = listBlock.children('.sotable-btn-valname-box')
                const currentVariableName = sotableBtnValnameBox.children('label').text();
                variableListForTextWithLabel.push(currentVariableName)
                let plainText = listBlock.children('input:text').val();
                cmdVariableList.push(`${currentVariableName}="${plainText}"`)
                clipVariablesList.push(currentVariableName);
            });
        }

        function getFromTextForm(
            textFormFields,
            cmdVariableList,
            clipVariablesList,
            setVariableTypeList
        ){
            textFormFields.each(function() {
                let listBlock = $(this);
                let sotableBtnValnameBox = listBlock.children('.sotable-btn-valname-box')
                const currentVariableName = sotableBtnValnameBox.children('label').text();
                let plainText = listBlock.children('input:text').val();
                cmdVariableList.push(`${currentVariableName}="${plainText}"`)
                clipVariablesList.push(currentVariableName);
            });
        }

        function getFromUrlLaunchForm(
            urlFormFields,
            cmdVariableList,
            setVariableTypeList,
            launchVariableList
        ){
            urlFormFields.each(function() {
                let listBlock = $(this);
                let sotableBtnValnameBox = listBlock.children('.sotable-btn-valname-box')
                const elcbbVariableName = sotableBtnValnameBox.children('label').text();
                cmdVariableList.push(`${elcbbVariableName}=""`)
                launchVariableList.push(elcbbVariableName)
                let selectTag = listBlock.children('select');
                let options = selectTag.children();
                const listContents = options.map(function() {
                    return $(this).text()
                }).get().join('\n');
                const listFilePath = `${targetAppListDirPath}/${elcbbVariableName}List`;
                setVariableTypeList.push(
                    `${setVariableTypeName}="${elcbbVariableName}:${elcbbMark}=${elcbKeys.listPath}=${listFilePath}?${elcbKeys.limitNum}=20|${ButtonKeys.cmd}=jsf '\${0}' ${elcbbVariableName}"`
                )
                jsFileSystem.writeLocalFile(
                    listFilePath,
                    listContents
                );
            });
        };

        function getFromNewLineForm(
            inputParts,
            index,
            clipVariablesList,
            cmdVariableList,
            setVariableTypeList,
        ){
            clipVariablesList.push(
                newlineVariableValueEscape
            );
            cmdVariableList.push(
                newlineVariableValueEscape
            );
            try{
                var nextInputForm = inputParts.eq(index + 1);
                const nextClassName = nextInputForm.attr('class');
                var includeNextNewline = nextClassName.includes(
                    INPUT_CLASS_TYPE.newLineFieldclass
                );
            } catch(e){
                var includeNextNewline = false
            };
            if(includeNextNewline) return;
            try {
                var inputPartsRev = inputParts
                    .slice(0, index + 1)
                    .get()
                    .reverse();
            } catch(e) {
                var inputPartsRev = inputParts.reverse();
            };
            const displayNewLineLength = inputPartsRev.findIndex(
                function(currentInputForm, order){
                    const currentClassName = currentInputForm.className;
                    return !currentClassName.includes(
                        INPUT_CLASS_TYPE.newLineFieldclass
                    );
                });
            setVariableTypeList.push(
                `${setVariableTypeName}="${newlineVariableName}:RO="`
            );
            cmdVariableList.push(
                `${newlineVariableName}="${"|n".repeat(displayNewLineLength)}"`
            );
        };


        let EDIT_TYPE = {
            txt : 'text',
            sl : 'select',
        };

        function editSelect(
            listBlock,
            sotableBtnValnameBox
        ) {
            const getedType = getType(listBlock);
            switch (getedType){
                case EDIT_TYPE.txt:
                    textBoxEdit(
                        listBlock,
                        sotableBtnValnameBox
                    );
                    break;
                case EDIT_TYPE.sl:
                    checkBoxEdit(
                        listBlock,
                        sotableBtnValnameBox
                    );
                    break;
            }
        }


        function textBoxEdit(
            listBlock,
            sotableBtnValnameBox
        ){
            var dialog = $(".dialog");
            let dialogForm = dialog.children('.dialogForm')
            dialogForm.empty();
            dialogForm.append(`<form ></form>`)
            let formBody = dialogForm.children('form')
            formBody.append(`<label for="editLabel">edit variable:</label>`)
            let labelTag = sotableBtnValnameBox.children('label');
            formBody.append(`<input type="text" class="editLabel" value="${labelTag.text()}" style="margin: 5px;"><br>`)
            // ダイアログを表示
            dialog.css("display", "block")
            $(".dialog").dialog({
                modal:true, //モーダル表示
                title:"edit dialog", //タイトル
                buttons: { //ボタン
                    "cancel": function() {
                        $(this).dialog("close");
                    },
                    "ok": function() {
                        execReflectForText(
                            formBody,
                            listBlock,
                            sotableBtnValnameBox
                        )
                        $(this).dialog("close");
                    }
                }
            });
        }


        function execReflectForText(
            formBody,
            listBlock,
            sotableBtnValnameBox,
        ){
            let inputTexts = formBody.children("input:text");
            let inputTextList = inputTexts.map(
                function(){
                    return $(this).val();
                }
            ).get();
            const labelValue = inputTextList.at(0)
            const checkResult = numberZenkakuSimbolCheck(labelValue);
            if(!checkResult) return
            const labelTag = sotableBtnValnameBox.children("label")
            labelTag.text(labelValue)
        }



        function checkBoxEdit(
            listBlock,
            sotableBtnValnameBox,
        ){
            var dialog = $(".dialog");
            let dialogForm = dialog.children('.dialogForm')
            dialogForm.empty();
            dialogForm.append(`<form ></form>`)
            let formBody = dialogForm.children('form')
            formBody.append(`<label for="editLabel">edit variable:</label>`)
            let labelTag = sotableBtnValnameBox.children('label');
            formBody.append(`<input type="text" class="editLabel" value="${labelTag.text()}"><br>`)
            formBody.append(`<label for="newOption">edit Option:</label>`)
            formBody.append('<div id="check_box_inputs"></div>')
            let checkBoxInputs = formBody.children('#check_box_inputs');
            let selectTag = listBlock.children('select');
            const enableUlrElcb = listBlock.attr("class").includes(INPUT_BLOCK_CLASS.upUrlOrCopyBlock);
            addOpToDialog(
                checkBoxInputs,
                selectTag,
                enableUlrElcb
            );
            dialogForm.append(`<br><br><input type="button" class="add_button" onClick="addInput(this)" value="Add">`
            )
            sortableJsWrapper('check_box_inputs');
            // ダイアログを表示
            dialog.css("display", "block")
            $(".dialog").dialog({
                modal:true, //モーダル表示
                title:"edit dialog", //タイトル
                buttons: { //ボタン
                    "cancel": function() {
                        $(this).dialog("close");
                    },
                    "ok": function() {
                        execReflectForCb(
                            formBody,
                            listBlock,
                            sotableBtnValnameBox,
                            selectTag,
                            checkBoxInputs,
                        )
                        $(this).dialog("close");
                    }
                }
            });
        }

        function addOpToDialog(
            checkBoxInputs,
            selectTag,
            enableUlrElcb
        ){
            let options = selectTag.children();
            var roopTimes = 0;
            var addClass = "cb-dialog-item";
            if(enableUlrElcb) addClass += ` ${INPUT_BLOCK_CLASS.upUrlOrCopyBlock}`;
            options.each(function() {
                const v = $(this).val();
                const t = $(this).text();
                checkBoxInputs.append(
                    `<div class="${addClass}"><input type="text" id="editOption${roopTimes}" class="edit-cb-input" value="${t}"></div>`
                )
                roopTimes++
            });
        }

        function execReflectForCb(
            formBody,
            listBlock,
            sotableBtnValnameBox,
            selectTag,
            checkBoxInputs,
        ){
            let inputTexts = formBody.children("input:text");
            let inputTextList = inputTexts.map(
                function(){
                    return $(this).val();
                }
            ).get();
            const labelValue = inputTextList.at(0)
            const checkResult = numberZenkakuSimbolCheck(labelValue);
            if(!checkResult) return
            const labelTag = sotableBtnValnameBox.children("label")
            labelTag.text(labelValue)
            let optionList = checkBoxInputs.children().map(
                function(){
                    return $(this).children("input:text").val()
                }
            ).get();
            selectTag.empty()
            var optionInsertTimes = 0;
            optionList.forEach(function(element) {
                if(!element) return
                selectTag.append(`<option value="${optionInsertTimes}">${element}</option>`)
            });
        }

        function numberZenkakuSimbolCheck(
            labelValue
        ){
            if(prefixNumRegex.test(labelValue)) {
                alert("no number prefix")
                return false
            }
            if(zenkakuSimbolRegex.test(labelValue)) {
                alert("no zenkaku or simbol")
                return false
            }
            return true
        }

        function addInput(button){
            let checkBoxInputs = $('#check_box_inputs')
            checkBoxInputs.append(`<div class="cb-dialog-item"><input type="text" class="edit-cb-input" value=""><div>`)

        }

        function getType(element) {
            const type = element.children("input").prop('type');
            if(type != undefined) return type
            return element.children("select").attr("id");
        }

        function closeDialog() {
            var dialog = $(".dialog");
            dialog.css('display','none')
        }

        function sortableJsWrapper(selectorId){
            var el = document.getElementById(selectorId);
            var sortable = new Sortable(el, {
                delay: 100,
                removeOnSpill: true,
                onEnd: function (/**Event*/evt) {
                    var target = evt.originalEvent.target;
                    if (
                        el === target || el.contains(target)
                    ) return false
                    removeConfirmForSort(evt)
                    return false
                },
            });
        }

        function makeRandomValName() {
            return Array.from(
                crypto.getRandomValues(
                    new Uint8Array(N))
            ).map(
                (n) => S[n%S.length]
            ).join('')
        }

        function removeConfirmForSort(evt){
            const confirmBool = confirm("delete ok?")
            if(confirmBool) return
            var items = evt.from.getElementsByClassName(INPUT_BLOCK_CLASS.listBoxBlock);
            evt.from.insertBefore(evt.item, items[evt.oldIndex]);
        }
    </script>

</body>
</html>
